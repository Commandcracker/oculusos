local function a(b)local c=setmetatable({},{__index=_ENV or getfenv()})if setfenv then setfenv(b,c)end;return b(c)or c end;local d=a(function(b,...)local c=math.floor;local e,f;f=function(g,h)return c(g%4294967296/2^h)end;e=function(g,h)return g*2^h%4294967296 end;return{bnot=bit.bnot,band=bit.band,bor=bit.bor,bxor=bit.bxor,rshift=f,lshift=e}end)local i=a(function(b,...)local c=d.bxor;local e=d.lshift;local f=0x100;local g=0xff;local h=0x11b;local j={}local k={}local function l(m,n)return c(m,n)end;local function o(m,n)return c(m,n)end;local function p(m)if m==1 then return 1 end;local n=g-k[m]return j[n]end;local function q(m,n)if m==0 or n==0 then return 0 end;local r=k[m]+k[n]if r>=g then r=r-g end;return j[r]end;local function s(m,n)if m==0 then return 0 end;local r=k[m]-k[n]if r<0 then r=r+g end;return j[r]end;local function t()for m=1,f do print("log(",m-1,")=",k[m-1])end end;local function u()for m=1,f do print("exp(",m-1,")=",j[m-1])end end;local function v()local m=1;for n=0,g-1 do j[n]=m;k[m]=n;m=c(e(m,1),m)if m>g then m=o(m,h)end end end;v()return{add=l,sub=o,invert=p,mul=q,div=dib,printLog=t,printExp=u}end)util=a(function(b,...)local c=d.bxor;local e=d.rshift;local f=d.band;local g=d.lshift;local h;local function j(w)w=c(w,e(w,4))w=c(w,e(w,2))w=c(w,e(w,1))return f(w,1)end;local function k(w,x)if x==0 then return f(w,0xff)else return f(e(w,x*8),0xff)end end;local function l(w,x)if x==0 then return f(w,0xff)else return g(f(w,0xff),x*8)end end;local function o(w,x,y)local z={}for A=0,y-1 do z[A+1]=l(w[x+A*4],3)+l(w[x+A*4+1],2)+l(w[x+A*4+2],1)+l(w[x+A*4+3],0)if y%10000==0 then h()end end;return z end;local function p(w,x,y,z)z=z or#w;for A=0,z-1 do for B=0,3 do x[y+A*4+3-B]=k(w[A+1],B)end;if z%10000==0 then h()end end;return x end;local function q(w)local x=""for y,z in ipairs(w)do x=x..string.format("%02x ",z)end;return x end;local function s(w)local x={}for y=1,#w,2 do x[#x+1]=tonumber(w:sub(y,y+1),16)end;return x end;local function t(w)local x=type(w)if x=="number"then return string.format("%08x",w)elseif x=="table"then return q(w)elseif x=="string"then local y={string.byte(w,1,#w)}return q(y)else return w end end;local function u(w)local x=#w;local y=math.random(0,255)local z=math.random(0,255)local A=string.char(y,z,y,z,k(x,3),k(x,2),k(x,1),k(x,0))w=A..w;local B=math.ceil(#w/16)*16-#w;local C=""for D=1,B do C=C..string.char(math.random(0,255))end;return w..C end;local function v(w)local x={string.byte(w,1,4)}if x[1]==x[3]and x[2]==x[4]then return true end;return false end;local function m(w)if not v(w)then return nil end;local x=l(string.byte(w,5),3)+l(string.byte(w,6),2)+l(string.byte(w,7),1)+l(string.byte(w,8),0)return string.sub(w,9,8+x)end;local function n(w,x)for y=1,16 do w[y]=c(w[y],x[y])end end;local function r(w)local x=16;while true do local y=w[x]+1;if y>=256 then w[x]=y-256;x=(x-2)%16+1 else w[x]=y;break end end end;local E,F,G=os.queueEvent,coroutine.yield,os.time;local H=G()local function h()local w=G()if w-H>=0.03 then H=w;E("sleep")F("sleep")end end;local function I(w)local x,y,z,A=string.char,math.random,h,table.insert;local B={}for C=1,w do A(B,y(0,255))if C%10240==0 then z()end end;return B end;local function J(w)local x,y,z,A=string.char,math.random,h,table.insert;local B={}for C=1,w do A(B,x(y(0,255)))if C%10240==0 then z()end end;return table.concat(B)end;return{byteParity=j,getByte=k,putByte=l,bytesToInts=o,intsToBytes=p,bytesToHex=q,hexToBytes=s,toHexString=t,padByteString=u,properlyDecrypted=v,unpadByteString=m,xorIV=n,increment=r,sleepCheckIn=h,getRandomData=I,getRandomString=J}end)aes=a(function(b,...)local c=util.putByte;local e=util.getByte;local f='rounds'local g="type"local h=1;local j=2;local k={}local l={}local o={}local p={}local q={}local s={}local t={}local u={}local v={}local m={}local n={0x01000000,0x02000000,0x04000000,0x08000000,0x10000000,0x20000000,0x40000000,0x80000000,0x1b000000,0x36000000,0x6c000000,0xd8000000,0xab000000,0x4d000000,0x9a000000,0x2f000000}local function r(K)mask=0xf8;result=0;for L=1,8 do result=d.lshift(result,1)parity=util.byteParity(d.band(K,mask))result=result+parity;lastbit=d.band(mask,1)mask=d.band(d.rshift(mask,1),0xff)if lastbit~=0 then mask=d.bor(mask,0x80)else mask=d.band(mask,0x7f)end end;return d.bxor(result,0x63)end;local function E()for K=0,255 do if K~=0 then inverse=i.invert(K)else inverse=K end;mapped=r(inverse)k[K]=mapped;l[mapped]=K end end;local function F()for K=0,255 do byte=k[K]o[K]=c(i.mul(0x03,byte),0)+c(byte,1)+c(byte,2)+c(i.mul(0x02,byte),3)p[K]=c(byte,0)+c(byte,1)+c(i.mul(0x02,byte),2)+c(i.mul(0x03,byte),3)q[K]=c(byte,0)+c(i.mul(0x02,byte),1)+c(i.mul(0x03,byte),2)+c(byte,3)s[K]=c(i.mul(0x02,byte),0)+c(i.mul(0x03,byte),1)+c(byte,2)+c(byte,3)end end;local function G()for K=0,255 do byte=l[K]t[K]=c(i.mul(0x0b,byte),0)+c(i.mul(0x0d,byte),1)+c(i.mul(0x09,byte),2)+c(i.mul(0x0e,byte),3)u[K]=c(i.mul(0x0d,byte),0)+c(i.mul(0x09,byte),1)+c(i.mul(0x0e,byte),2)+c(i.mul(0x0b,byte),3)v[K]=c(i.mul(0x09,byte),0)+c(i.mul(0x0e,byte),1)+c(i.mul(0x0b,byte),2)+c(i.mul(0x0d,byte),3)m[K]=c(i.mul(0x0e,byte),0)+c(i.mul(0x0b,byte),1)+c(i.mul(0x0d,byte),2)+c(i.mul(0x09,byte),3)end end;local function H(K)local L=d.band(K,0xff000000)return d.lshift(K,8)+d.rshift(L,24)end;local function I(K)return c(k[e(K,0)],0)+c(k[e(K,1)],1)+c(k[e(K,2)],2)+c(k[e(K,3)],3)end;local function J(K)local L={}local M=math.floor(#K/4)if M~=4 and M~=6 and M~=8 or M*4~=#K then error("Invalid key size: "..tostring(M))return nil end;L[f]=M+6;L[g]=h;for N=0,M-1 do L[N]=c(K[N*4+1],3)+c(K[N*4+2],2)+c(K[N*4+3],1)+c(K[N*4+4],0)end;for N=M,(L[f]+1)*4-1 do local O=L[N-1]if N%M==0 then O=H(O)O=I(O)local P=math.floor(N/M)O=d.bxor(O,n[P])elseif M>6 and N%M==4 then O=I(O)end;L[N]=d.bxor(L[N-M],O)end;return L end;local function w(K)local L=e(K,3)local M=e(K,2)local N=e(K,1)local O=e(K,0)return c(i.add(i.add(i.add(i.mul(0x0b,M),i.mul(0x0d,N)),i.mul(0x09,O)),i.mul(0x0e,L)),3)+c(i.add(i.add(i.add(i.mul(0x0b,N),i.mul(0x0d,O)),i.mul(0x09,L)),i.mul(0x0e,M)),2)+c(i.add(i.add(i.add(i.mul(0x0b,O),i.mul(0x0d,L)),i.mul(0x09,M)),i.mul(0x0e,N)),1)+c(i.add(i.add(i.add(i.mul(0x0b,L),i.mul(0x0d,M)),i.mul(0x09,N)),i.mul(0x0e,O)),0)end;local function x(K)local L=e(K,3)local M=e(K,2)local N=e(K,1)local O=e(K,0)local P=d.bxor(O,N)local Q=d.bxor(M,L)local R=d.bxor(P,Q)R=d.bxor(R,i.mul(0x08,R))p=d.bxor(R,i.mul(0x04,d.bxor(N,L)))R=d.bxor(R,i.mul(0x04,d.bxor(O,M)))return c(d.bxor(d.bxor(O,R),i.mul(0x02,d.bxor(L,O))),0)+c(d.bxor(d.bxor(N,p),i.mul(0x02,P)),1)+c(d.bxor(d.bxor(M,R),i.mul(0x02,d.bxor(L,O))),2)+c(d.bxor(d.bxor(L,p),i.mul(0x02,Q)),3)end;local function y(K)local L=J(K)if L==nil then return nil end;L[g]=j;for M=4,(L[f]+1)*4-5 do L[M]=w(L[M])end;return L end;local function z(K,L,M)for N=0,3 do K[N+1]=d.bxor(K[N+1],L[M*4+N])end end;local function A(K,L)L[1]=d.bxor(d.bxor(d.bxor(o[e(K[1],3)],p[e(K[2],2)]),q[e(K[3],1)]),s[e(K[4],0)])L[2]=d.bxor(d.bxor(d.bxor(o[e(K[2],3)],p[e(K[3],2)]),q[e(K[4],1)]),s[e(K[1],0)])L[3]=d.bxor(d.bxor(d.bxor(o[e(K[3],3)],p[e(K[4],2)]),q[e(K[1],1)]),s[e(K[2],0)])L[4]=d.bxor(d.bxor(d.bxor(o[e(K[4],3)],p[e(K[1],2)]),q[e(K[2],1)]),s[e(K[3],0)])end;local function B(K,L)L[1]=c(k[e(K[1],3)],3)+c(k[e(K[2],2)],2)+c(k[e(K[3],1)],1)+c(k[e(K[4],0)],0)L[2]=c(k[e(K[2],3)],3)+c(k[e(K[3],2)],2)+c(k[e(K[4],1)],1)+c(k[e(K[1],0)],0)L[3]=c(k[e(K[3],3)],3)+c(k[e(K[4],2)],2)+c(k[e(K[1],1)],1)+c(k[e(K[2],0)],0)L[4]=c(k[e(K[4],3)],3)+c(k[e(K[1],2)],2)+c(k[e(K[2],1)],1)+c(k[e(K[3],0)],0)end;local function C(K,L)L[1]=d.bxor(d.bxor(d.bxor(t[e(K[1],3)],u[e(K[4],2)]),v[e(K[3],1)]),m[e(K[2],0)])L[2]=d.bxor(d.bxor(d.bxor(t[e(K[2],3)],u[e(K[1],2)]),v[e(K[4],1)]),m[e(K[3],0)])L[3]=d.bxor(d.bxor(d.bxor(t[e(K[3],3)],u[e(K[2],2)]),v[e(K[1],1)]),m[e(K[4],0)])L[4]=d.bxor(d.bxor(d.bxor(t[e(K[4],3)],u[e(K[3],2)]),v[e(K[2],1)]),m[e(K[1],0)])end;local function D(K,L)L[1]=c(l[e(K[1],3)],3)+c(l[e(K[4],2)],2)+c(l[e(K[3],1)],1)+c(l[e(K[2],0)],0)L[2]=c(l[e(K[2],3)],3)+c(l[e(K[1],2)],2)+c(l[e(K[4],1)],1)+c(l[e(K[3],0)],0)L[3]=c(l[e(K[3],3)],3)+c(l[e(K[2],2)],2)+c(l[e(K[1],1)],1)+c(l[e(K[4],0)],0)L[4]=c(l[e(K[4],3)],3)+c(l[e(K[3],2)],2)+c(l[e(K[2],1)],1)+c(l[e(K[1],0)],0)end;local function S(K,L,M,N,O)M=M or 1;N=N or{}O=O or 1;local P={}local Q={}if K[g]~=h then error("No encryption key: "..tostring(K[g])..", expected "..h)return end;P=util.bytesToInts(L,M,4)z(P,K,0)local R=1;while R<K[f]-1 do A(P,Q)z(Q,K,R)R=R+1;A(Q,P)z(P,K,R)R=R+1 end;A(P,Q)z(Q,K,R)R=R+1;B(Q,P)z(P,K,R)util.sleepCheckIn()return util.intsToBytes(P,N,O)end;local function T(K,L,M,N,O)M=M or 1;N=N or{}O=O or 1;local P={}local Q={}if K[g]~=j then error("No decryption key: "..tostring(K[g]))return end;P=util.bytesToInts(L,M,4)z(P,K,K[f])local R=K[f]-1;while R>2 do C(P,Q)z(Q,K,R)R=R-1;C(Q,P)z(P,K,R)R=R-1 end;C(P,Q)z(Q,K,R)R=R-1;D(Q,P)z(P,K,R)util.sleepCheckIn()return util.intsToBytes(P,N,O)end;E()F()G()return{ROUNDS=f,KEY_TYPE=g,ENCRYPTION_KEY=h,DECRYPTION_KEY=j,expandEncryptionKey=J,expandDecryptionKey=y,encrypt=S,decrypt=T}end)local U=a(function(b,...)local function c()return{}end;local function e(g,h)table.insert(g,h)end;local function f(g)return table.concat(g)end;return{new=c,addString=e,toString=f}end)ciphermode=a(function(b,...)local c={}local e=math.random;function c.encryptString(f,g,h,j)if j then local o={}for p=1,16 do o[p]=j[p]end;j=o else j={0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0}end;local k=aes.expandEncryptionKey(f)local l=U.new()for o=1,#g/16 do local p=(o-1)*16+1;local q={string.byte(g,p,p+15)}j=h(k,q,j)U.addString(l,string.char(unpack(q)))end;return U.toString(l)end;function c.encryptECB(f,g,h)aes.encrypt(f,g,1,g,1)end;function c.encryptCBC(f,g,h)util.xorIV(g,h)aes.encrypt(f,g,1,g,1)return g end;function c.encryptOFB(f,g,h)aes.encrypt(f,h,1,h,1)util.xorIV(g,h)return h end;function c.encryptCFB(f,g,h)aes.encrypt(f,h,1,h,1)util.xorIV(g,h)return g end;function c.encryptCTR(f,g,h)local j={}for k=1,16 do j[k]=h[k]end;aes.encrypt(f,h,1,h,1)util.xorIV(g,h)util.increment(j)return j end;function c.decryptString(f,g,h,j)if j then local o={}for p=1,16 do o[p]=j[p]end;j=o else j={0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0}end;local k;if h==c.decryptOFB or h==c.decryptCFB or h==c.decryptCTR then k=aes.expandEncryptionKey(f)else k=aes.expandDecryptionKey(f)end;local l=U.new()for o=1,#g/16 do local p=(o-1)*16+1;local q={string.byte(g,p,p+15)}j=h(k,q,j)U.addString(l,string.char(unpack(q)))end;return U.toString(l)end;function c.decryptECB(f,g,h)aes.decrypt(f,g,1,g,1)return h end;function c.decryptCBC(f,g,h)local j={}for k=1,16 do j[k]=g[k]end;aes.decrypt(f,g,1,g,1)util.xorIV(g,h)return j end;function c.decryptOFB(f,g,h)aes.encrypt(f,h,1,h,1)util.xorIV(g,h)return h end;function c.decryptCFB(f,g,h)local j={}for k=1,16 do j[k]=g[k]end;aes.encrypt(f,h,1,h,1)util.xorIV(g,h)return j end;c.decryptCTR=c.encryptCTR;return c end)AES128=16;AES192=24;AES256=32;ECBMODE=1;CBCMODE=2;OFBMODE=3;CFBMODE=4;CTRMODE=4;local function V(b,c,e)local f=c;if c==AES192 then f=32 end;if f>#b then local h=""for j=1,f-#b do h=h..string.char(0)end;b=b..h else b=string.sub(b,1,f)end;local g={string.byte(b,1,#b)}b=ciphermode.encryptString(g,b,ciphermode.encryptCBC,e)b=string.sub(b,1,c)return{string.byte(b,1,#b)}end;function encrypt(b,c,e,f,g)assert(b~=nil,"Empty password.")assert(b~=nil,"Empty data.")local f=f or CBCMODE;local e=e or AES128;local h=V(b,e,g)local j=util.padByteString(c)if f==ECBMODE then return ciphermode.encryptString(h,j,ciphermode.encryptECB,g)elseif f==CBCMODE then return ciphermode.encryptString(h,j,ciphermode.encryptCBC,g)elseif f==OFBMODE then return ciphermode.encryptString(h,j,ciphermode.encryptOFB,g)elseif f==CFBMODE then return ciphermode.encryptString(h,j,ciphermode.encryptCFB,g)elseif f==CTRMODE then return ciphermode.encryptString(h,j,ciphermode.encryptCTR,g)else error("Unknown mode",2)end end;function decrypt(b,c,e,f,g)local f=f or CBCMODE;local e=e or AES128;local h=V(b,e,g)local j;if f==ECBMODE then j=ciphermode.decryptString(h,c,ciphermode.decryptECB,g)elseif f==CBCMODE then j=ciphermode.decryptString(h,c,ciphermode.decryptCBC,g)elseif f==OFBMODE then j=ciphermode.decryptString(h,c,ciphermode.decryptOFB,g)elseif f==CFBMODE then j=ciphermode.decryptString(h,c,ciphermode.decryptCFB,g)elseif f==CTRMODE then j=ciphermode.decryptString(h,c,ciphermode.decryptCTR,g)else error("Unknown mode",2)end;result=util.unpadByteString(j)if result==nil then return nil end;return result end