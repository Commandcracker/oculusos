local type=type;local a={}for b=0,16 do a[2^b]=string.format("%x",b)end;local function c(d,e,f,g)local h,i=d.getSize()for j=1,i do e.setCursorPos(1,j)if f then e.blit(f(j))end end;local k,j=d.getCursorPos()e.setCursorPos(k,j-g)if d.getCursorBlink then e.setCursorBlink(d.getCursorBlink())end;e.setTextColour(d.getTextColour())e.setBackgroundColour(d.getBackgroundColour())if d.getPaletteColour and e.getPaletteColour then for b=0,15 do e.setPaletteColour(2^b,d.getPaletteColour(2^b))end end end;function create(l)if not l then l=term.current()end;local m={}local n={}local o={}local p={}local q,r=1,1;local s=0;local t=r;local u=false;local v="0"local w="f"local x,i=l.getSize()local y=l.isColor()local z=100;local A,B=true,nil;local C=0;local D={}if term.native().getPaletteColour then for b=0,15 do local E=2^b;p[E]={term.native().getPaletteColour(E)}end end;local function F()if z>-1 then while s>z do table.remove(m,1)table.remove(n,1)table.remove(o,1)s=s-1 end end;t=s+r end;function D.write(G)if B then return B.write(G)end;G=tostring(G)if A then l.write(G)end;local H=q;if r>i or r<1 then q=H+#G;return end;if H+#G<=1 or H>x then q=H+#G;return elseif H<1 then G=string.sub(G,-H+2)H=1 end;local I=m[t]local J=n[t]local K=o[t]local L=H-1;local M=math.min(1,L)local N=H+#G;local O=x;local P,Q=string.sub,string.rep;m[t]=P(I,M,L)..G..P(I,N,O)n[t]=P(J,M,L)..Q(v,#G)..P(J,N,O)o[t]=P(K,M,L)..Q(w,#G)..P(K,N,O)q=H+#G end;function D.blit(G,R,S)if B then return B.blit(G,R,S)end;if type(G)~="string"then error("bad argument #1 (expected string, got "..type(G)..")",2)end;if type(R)~="string"then error("bad argument #2 (expected string, got "..type(R)..")",2)end;if type(S)~="string"then error("bad argument #3 (expected string, got "..type(S)..")",2)end;if#R~=#G or#S~=#G then error("Arguments must be the same length",2)end;if A then l.blit(G,R,S)end;local H=q;if r>i or r<1 then q=H+#G;return end;if H+#G<=1 then q=H+#G;return elseif H<1 then G=string.sub(G,math.abs(q)+2)R=string.sub(R,math.abs(q)+2)S=string.sub(S,math.abs(q)+2)q=1 elseif H>x then q=H+#G;return else G=G end;local I=m[t]local J=n[t]local K=o[t]local L=q-1;local M=math.min(1,L)local N=q+#G;local O=x;local P=string.sub;m[t]=P(I,M,L)..G..P(I,N,O)n[t]=P(J,M,L)..R..P(J,N,O)o[t]=P(K,M,L)..S..P(K,N,O)q=H+#G end;function D.clear()if B then return B.clear()end;if C>0 then return D.beginPrivateMode().clear()end;local T=(" "):rep(x)local U=v:rep(x)local V=w:rep(x)for b=s+1,i+s do m[b]=T;n[b]=U;o[b]=V end;if A then return l.clear()end end;function D.clearLine()if B then return B.clearLine()end;if r>i or r<1 then return end;m[t]=string.rep(" ",x)n[t]=string.rep(v,x)o[t]=string.rep(w,x)if A then return l.clearLine()end end;function D.getCursorPos()if B then return B.getCursorPos()end;return q,r end;function D.setCursorPos(k,j)if B then return B.setCursorPos(k,j)end;if type(k)~="number"then error("bad argument #1 (expected number, got "..type(k)..")",2)end;if type(j)~="number"then error("bad argument #2 (expected number, got "..type(j)..")",2)end;local W=math.floor(j)if W>=1 and W<C then return D.beginPrivateMode().setCursorPos(k,j)end;q=math.floor(k)r=W;t=W+s;if A then return l.setCursorPos(k,j)end end;function D.setCursorBlink(X)if B then return B.setCursorBlink(X)end;if type(X)~="boolean"then error("bad argument #1 (expected boolean, got "..type(X)..")",2)end;u=X;if A then return l.setCursorBlink(X)end end;function D.getCursorBlink()if B then return B.getCursorBlink()end;return u end;function D.getSize()if B then return B.getSize()end;return x,i end;function D.scroll(Y)if B then return B.scroll(Y)end;if type(Y)~="number"then error("bad argument #1 (expected number, got "..type(Y)..")",2)end;if Y>0 then s=s+Y;for b=i+s-Y+1,i+s do m[b]=string.rep(" ",x)n[b]=string.rep(v,x)o[b]=string.rep(w,x)end;F()elseif Y<0 then for b=i+t,math.abs(Y)+1+t,-1 do if m[b+Y]then m[b]=m[b+Y]n[b]=n[b+Y]o[b]=o[b+Y]end end;for b=t,math.abs(Y)+t do m[b]=string.rep(" ",x)n[b]=string.rep(v,x)o[b]=string.rep(w,x)end end;C=C-Y;if A then return l.scroll(Y)end end;function D.setTextColour(Z)if B then return B.setTextColour(Z)end;if type(Z)~="number"then error("bad argument #1 (expected number, got "..type(Z)..")",2)end;v=a[Z]or error("Invalid colour (got "..Z..")",2)if A then return l.setTextColour(Z)end end;D.setTextColor=D.setTextColour;function D.setBackgroundColour(Z)if B then return B.setBackgroundColour(Z)end;if type(Z)~="number"then error("bad argument #1 (expected number, got "..type(Z)..")",2)end;w=a[Z]or error("Invalid colour (got "..Z..")",2)if A then return l.setBackgroundColour(Z)end end;D.setBackgroundColor=D.setBackgroundColour;function D.isColour()if B then return B.isColour()end;return y==true end;D.isColor=D.isColour;function D.getTextColour()if B then return B.getTextColour()end;return 2^tonumber(v,16)end;D.getTextColor=D.getTextColour;function D.getBackgroundColour()if B then return B.getBackgroundColour()end;return 2^tonumber(w,16)end;D.getBackgroundColor=D.getBackgroundColour;if l.getPaletteColour then function D.setPaletteColour(_,a0,a1,X)if B then return B.setPaletteColour(_,a0,a1,X)end;local a2=p[_]if not a2 then error("Invalid colour (got "..tostring(_)..")",2)end;if type(a0)=="number"and a1==nil and X==nil then a2[1],a2[2],a2[3]=colours.rgb8(a0)else if type(a0)~="number"then error("bad argument #2 (expected number, got "..type(a0)..")",2)end;if type(a1)~="number"then error("bad argument #3 (expected number, got "..type(a1)..")",2)end;if type(X)~="number"then error("bad argument #4 (expected number, got "..type(X)..")",2)end;a2[1],a2[2],a2[3]=a0,a1,X end;if A then return l.setPaletteColour(_,a0,a1,X)end end;D.setPaletteColor=D.setPaletteColour;function D.getPaletteColour(_)if B then return B.getPaletteColour(_)end;local a2=p[_]if not a2 then error("Invalid colour (got "..tostring(_)..")",2)end;return a2[1],a2[2],a2[3]end;D.getPaletteColor=D.getPaletteColour end;function D.draw(a3,a4)if B then return end;local s=s+(a3 or 0)c(D,l,function(b)local a5=s+b;return m[a5],n[a5],o[a5]end,a3)end;function D.bubble(X)A=X end;function D.setCursorThreshold(j)C=j end;function D.endPrivateMode(a6)if B then local a7=B;B=nil;D.draw(0)if a6 then if C>0 then D.scroll(C)end;print(a7.getLine)c(a7,D,a7.getLine,0)end end end;function D.beginPrivateMode()if not B then B=window.create(l,1,1,x,i,false)for j=1,i do B.setCursorPos(1,j)B.blit(m[j+s],n[j+s],o[j+s])end;B.setCursorPos(q,r)B.setCursorBlink(u)B.setTextColour(2^tonumber(v,16))B.setBackgroundColor(2^tonumber(w,16))if l.getPaletteColour then for b=0,15 do local a2=p[2^b]B.setPaletteColour(2^b,a2[1],a2[2],a2[3])end end;B.setVisible(true)end;return B end;function D.isPrivateMode()return B~=nil end;function D.getTotalHeight()return s end;function D.setMaxScrollback(Y)local a8=z;z=Y;if a8>z then F()end end;function D.updateSize()local a9,W=l.getSize()if a9==x and W==i then return end;if B then B.resize(1,1,x,i)end;local aa=#m;for j=1,aa do if a9<x then m[j]=m[j]:sub(1,a9)n[j]=n[j]:sub(1,a9)o[j]=o[j]:sub(1,a9)elseif a9>x then m[j]=m[j]..(" "):rep(a9-x)n[j]=n[j]..v:rep(a9-x)o[j]=o[j]..w:rep(a9-x)end end;if W>i then local T=(" "):rep(a9)local U=v:rep(a9)local V=w:rep(a9)for j=aa+1,W do m[j]=T;n[j]=U;o[j]=V end elseif W<i then r=r-i+W end;x=a9;i=W;s=#m-i;t=s+r;F()end;D.clear()return D end