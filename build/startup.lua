local a=dofile("rom/modules/main/cc/expect.lua").expect;local b=term.current()local c,d=b.getSize()local e={}local f=nil;local g=nil;local h=false;local i=false;local j=1;local k=false;local function l(m)if f~=m then if f then local n=e[f]n.window.setVisible(false)end;f=m;if f then local o=e[f]o.window.setVisible(true)o.bInteracted=true end end end;local function p(m,q)e[m].sTitle=q end;local function r(s,t,...)local u=e[s]local v=u.sFilter;if v==nil or v==t or t=="terminate"then local w=g;g=s;term.redirect(u.terminal)local x,y=coroutine.resume(u.co,t,...)u.terminal=term.current()if x then u.sFilter=y else printError(y)end;g=w end end;local function z(A,B,C,...)local D=table.pack(...)local s=#e+1;local u={}u.sTitle=fs.getName(C)if h then u.window=window.create(b,1,2,c,d-1,false)else u.window=window.create(b,1,1,c,d,false)end;u.co=coroutine.create(function()os.run(B,C,table.unpack(D,1,D.n))if not u.bInteracted then term.setCursorBlink(false)print("Press any key to continue")os.pullEvent("char")end end)u.sFilter=nil;u.terminal=u.window;u.bInteracted=false;e[s]=u;if A then l(s)end;r(s)return s end;local function E(s)local u=e[s]if coroutine.status(u.co)=="dead"then if f==s then l(nil)end;table.remove(e,s)if f==nil then if s>1 then l(s-1)elseif#e>0 then l(1)end end;if j~=1 then j=j-1 end;return true end;return false end;local function F()local G=false;for m=#e,1,-1 do G=G or E(m)end;return G end;local H,I,J,K;if b.isColor()then H,I=colors.yellow,colors.black;J,K=colors.black,colors.gray else H,I=colors.white,colors.black;J,K=colors.black,colors.gray end;local function L()if h then b.setCursorPos(1,1)b.setBackgroundColor(K)b.clearLine()local M=0;local N=b.getSize()if j~=1 then b.setTextColor(J)b.setBackgroundColor(K)b.write("<")M=1 end;for m=j,#e do if m==f then b.setTextColor(H)b.setBackgroundColor(I)else b.setTextColor(J)b.setBackgroundColor(K)end;b.write(" "..e[m].sTitle.." ")M=M+#e[m].sTitle+2 end;if M>N then b.setTextColor(J)b.setBackgroundColor(K)b.setCursorPos(N,1)b.write(">")k=true else k=false end;local u=e[f]if u then u.window.restoreCursor()end end end;local function O()local P,Q;if h then P=2;Q=d-1 else P=1;Q=d end;for m=1,#e do local u=e[m]local R,S=u.window.getCursorPos()if S>Q then u.window.scroll(S-Q)u.window.setCursorPos(R,Q)end;u.window.reposition(1,P,c,Q)end;i=true end;local function T(U)if h~=U then h=U;O()L()end end;local V={}function V.getFocus()return f end;function V.setFocus(m)a(1,m,"number")if m>=1 and m<=#e then l(m)L()return true end;return false end;function V.getTitle(m)a(1,m,"number")if m>=1 and m<=#e then return e[m].sTitle end;return nil end;function V.setTitle(m,W)a(1,m,"number")a(2,W,"string")if m>=1 and m<=#e then p(m,W)L()end end;function V.getCurrent()return g end;function V.launch(B,C,...)a(1,B,"table")a(2,C,"string")local X=term.current()T(#e+1>=2)local Y=z(false,B,C,...)L()term.redirect(X)return Y end;function V.getCount()return#e end;b.clear()T(false)z(true,{["shell"]=shell,["multishell"]=multishell},"/boot/.run")if not fs.exists("/services")then fs.makeDir("/services")end;for Z,_ in ipairs(fs.list("/services"))do if string.sub(_,1,1)~="."then local a0="/services/".._;z(false,{["shell"]=shell,["multishell"]=multishell},a0)end end;while#e>0 do local a1=table.pack(os.pullEventRaw())local t=a1[1]if t=="term_resize"then c,d=b.getSize()O()L()elseif t=="char"or t=="key"or t=="key_up"or t=="paste"or t=="terminate"then r(f,table.unpack(a1,1,a1.n))if E(f)then T(#e>=2)L()end elseif t=="mouse_click"then local a2,R,S=a1[2],a1[3],a1[4]if h and S==1 then if R==1 and j~=1 then j=j-1;L()elseif k and R==term.getSize()then j=j+1;L()else local a3=1;if j~=1 then a3=2 end;for m=j,#e do local a4=a3+#e[m].sTitle+1;if R>=a3 and R<=a4 then l(m)L()break end;a3=a4+1 end end else r(f,t,a2,R,h and S-1 or S)if E(f)then T(#e>=2)L()end end elseif t=="mouse_drag"or t=="mouse_up"or t=="mouse_scroll"then local a5,R,S=a1[2],a1[3],a1[4]if h and t=="mouse_scroll"and S==1 then if a5==-1 and j~=1 then j=j-1;L()elseif k and a5==1 then j=j+1;L()end elseif not(h and S==1)then r(f,t,a5,R,h and S-1 or S)if E(f)then T(#e>=2)L()end end else local a6=#e;for m=1,a6 do r(m,table.unpack(a1,1,a1.n))end;if F()then T(#e>=2)L()end end;if i then local a6=#e;for m=1,a6 do r(m,"term_resize")end;i=false;if F()then T(#e>=2)L()end end end;term.redirect(b)